USE NorthWind;
GO 
DROP 
  PROCEDURE IF EXISTS MonthlyDiscount;
GO CREATE PROCEDURE dbo.MonthlyDiscount (
  @CategoryName NVARCHAR(15)
) AS BEGIN;
DECLARE @CategoryID INT 
SET 
  NOCOUNT ON;
IF EXISTS (
  SELECT 
    1 
  FROM 
    dbo.Categories 
  WHERE 
    CategoryName = @CategoryName
) BEGIN;
UPDATE 
  [Order Details] 
SET 
  Discount = Discount + 0.05 
FROM 
  [Order Details] AS O 
  LEFT OUTER JOIN Products AS P ON O.ProductID = P.ProductID 
WHERE 
  P.CategoryID = @CategoryID 
  AND O.OrderID IN (
    SELECT 
      OrderId 
    FROM 
      dbo.[Order Details] 
    GROUP BY 
      OrderID 
    Having 
      SUM(Quantity * UnitPrice) < 50
  );
UPDATE 
  [Order Details] 
SET 
  Discount = Discount + 0.10 
FROM 
  [Order Details] AS O 
  LEFT OUTER JOIN Products AS P ON O.ProductID = P.ProductID 
WHERE 
  P.CategoryID = @CategoryID 
  AND O.OrderID IN (
    SELECT 
      OrderId 
    FROM 
      dbo.[Order Details] 
    GROUP BY 
      OrderID 
    Having 
      SUM(Quantity * UnitPrice) >= 50 
      AND SUM(Quantity * UnitPrice) < 100
  );
UPDATE 
  [Order Details] 
SET 
  Discount = Discount + 0.15 
FROM 
  [Order Details] AS O 
  LEFT OUTER JOIN Products AS P ON O.ProductID = P.ProductID 
WHERE 
  P.CategoryID = @CategoryID 
  AND O.OrderID IN (
    SELECT 
      OrderId 
    FROM 
      dbo.[Order Details] 
    GROUP BY 
      OrderID 
    Having 
      SUM(Quantity * UnitPrice) > 100
  );
END;
SET 
  NOCOUNT OFF;
END;


GO EXECUTE MonthlyDiscount @CategoryName = 'Beverages';
SELECT 
  O.OrderID, 
  O.Discount, 
  P.CategoryID 
FROM 
  dbo.[Order Details] AS O 
  LEFT OUTER JOIN Products P ON O.ProductID = P.ProductID 
WHERE 
  P.CategoryID = 1;

/*
OrderID	Discount	CategoryID
10253	0			1
10254	0.15		1
10255	0			1
10257	0			1
10258	0.2			1
10260	0.25		1
10261	0			1
10263	0			1
10264	0			1
10265	0			1
10267	0.15		1
10270	0			1
10273	0.05		1
10275	0.05		1
10280	0			1
10280	0			1
10281	0			1
10281	0			1
10284	0.25		1
10285	0.2			1
10286	0			1	
10287	0			1
10293	0			1
10293	0			1
10294	0			1
10294	0			1
10294	0			1
10297	0			1
10298	0			1
10299	0			1
10302	0			1
10305	0.1			1
10308	0			1
10309	0			1
10312	0			1
10312	0			1
10315	0			1
10315	0			1
10317	0			1
10318	0			1
10319	0			1
10321	0			1
10323	0			1
10324	0.15		1
10326	0			1
10327	0.2			1
10329	0.05		1
10335	0.2			1
10340	0.05		1
10342	0.2			1
10343	0			1
10347	0.15		1
10347	0.15		1
10348	0.15		1
10351	0.05		1
10352	0			1
10353	0.2			1
10354	0			1
10355	0			1
10358	0.05		1
10358	0.05		1
10360	0			1
10361	0.1			1
10363	0			1
10363	0			1
10367	0			1
10370	0.15		1
10372	0.25		1
10377	0.15		1
10380	0			1
10386	0			1
10386	0			1
10387	0			1
10389	0			1
10390	0.1			1
10393	0.25		1
10398	0			1
10399	0			1
10400	0			1
10406	0			1
10413	0			1
10413	0			1
10417	0			1
10418	0			1
10420	0.1			1
10424	0.2			1
10424	0.2			1
10425	0.25		1
10434	0.15		1
10435	0			1
10436	0.1			1
10438	0.2			1
10440	0.15		1
10444	0			1
10445	0			1
10446	0.1			1
10453	0.1			1
10455	0			1
10458	0			1
10460	0.25		1
10464	0			1
10465	0			1
10467	0			1
10468	0			1
10469	0.15		1
10472	0.05		1
10474	0			1
10475	0.15		1
10476	0			1
10477	0			1
10477	0.25		1
10479	0			1
10483	0.05		1
10485	0.1			1
10485	0.1			1
10490	0			1
10498	0			1
10502	0			1
10504	0			1
10506	0.1			1
10507	0.15		1
10508	0			1
10510	0.1			1
10512	0.15		1
10514	0			1
10517	0			1
10518	0			1
10518	0			1
10520	0			1
10521	0			1
10522	0.2			1
10524	0			1
10526	0.15		1
10530	0			1
10530	0			1
10538	0			1
10540	0			1
10541	0.1			1
10541	0.1			1
10544	0			1
10546	0			1
10548	0.25		1
10551	0.15		1
10552	0			1
10553	0			1
10555	0.2			1
10557	0			1
10565	0.1			1
10566	0			1
10569	0			1
10572	0.1			1
10573	0			1
10575	0			1
10576	0			1
10577	0			1
10577	0			1
10578	0			1
10579	0			1
10581	0.2			1
10582	0			1
10587	0			1
10589	0			1
10590	0			1
10593	0.2			1
10595	0.25		1
10596	0.2			1
10597	0.2			1
10604	0.1			1
10609	0			1
10611	0			1
10611	0			1
10612	0			1
10613	0			1
10614	0			1
10616	0.05		1
10616	0.05		1
10620	0			1
10621	0			1
10622	0			1
10623	0			1
10623	0.1			1
10628	0			1
10630	0			1
10631	0.1			1
10632	0.05		1
10634	0			1
10640	0.25		1
10641	0			1
10643	0.25		1
10644	0			1
10646	0.25		1
10647	0			1
10648	0.15		1
10654	0.1			1
10659	0.05		1
10661	0.2			1
10665	0			1
10670	0			1
10670	0			1
10672	0.1			1
10673	0			1
10682	0			1
10688	0			1
10689	0.25		1
10691	0			1
10691	0			1
10694	0			1
10695	0			1
10697	0.25		1
10697	0.25		1
10698	0.05		1
10700	0.2			1
10700	0.2			1
10701	0.15		1
10702	0			1
10703	0			1
10704	0			1
10706	0			1
10707	0.15		1
10714	0.25		1
10720	0			1
10722	0			1
10722	0			1
10729	0			1
10732	0			1
10734	0			1
10736	0			1
10740	0.2			1
10741	0.2			1
10749	0			1
10752	0			1
10757	0			1
10758	0			1
10760	0.25		1
10761	0			1
10762	0			1
10763	0			1
10764	0.1			1
10766	0			1
10773	0.2			1
10775	0			1
10780	0			1
10783	0			1
10784	0.15		1
10785	0			1
10786	0.2			1
10787	0.05		1
10788	0.05		1
10789	0			1
10792	0			1
10799	0.15		1
10805	0			1
10805	0			1
10806	0.25		1
10808	0.15		1
10810	0			1
10813	0.2			1
10814	0.15		1
10816	0.05		1
10817	0			1
10819	0			1
10819	0			1
10821	0			1
10822	0			1
10824	0			1
10827	0			1
10828	0			1
10829	0			1
10830	0			1
10831	0			1
10831	0			1
10831	0			1
10836	0			1
10837	0.25		1
10838	0.25		1
10840	0.2			1
10842	0			1
10842	0			1
10845	0.1			1
10846	0			1
10847	0.2			1
10850	0.15		1
10851	0.05		1
10852	0			1
10856	0			1
10858	0			1
10859	0.25		1
10860	0			1
10863	0.15		1
10864	0			1
10864	0			1
10865	0.05		1
10865	0.05		1
10866	0.25		1
10866	0.25		1
10868	0			1
10869	0			1
10870	0			1
10879	0			1
10880	0.2			1
10883	0			1
10885	0			1
10885	0			1
10885	0			1
10888	0			1
10889	0			1
10890	0			1
10893	0			1
10894	0.05		1
10895	0			1
10895	0			1
10899	0.15		1
10900	0.25		1
10905	0.05		1
10907	0			1
10911	0			1
10911	0			1
10918	0.25		1
10921	0			1
10922	0			1
10923	0.2			1
10923	0.2			1
10924	0			1
10927	0			1
10928	0			1
10929	0			1
10932	0.1			1
10935	0			1
10937	0			1
10938	0.25		1
10939	0.15		1
10939	0.15		1
10946	0			1
10951	0.05		1
10955	0.2			1
10957	0			1
10959	0.15		1
10960	0.25		1
10961	0			1
10962	0			1
10964	0			1
10968	0			1
10973	0			1
10975	0			1
10977	0			1
10979	0			1
10980	0.2			1
10981	0			1
10982	0			1
10984	0			1
10986	0			1
10987	0			1
10990	0.15		1
10991	0.2			1
10991	0.2			1
10991	0.2			1
10998	0			1
10998	0			1
11000	0.25		1
11002	0.15		1
11003	0			1
11004	0			1
11005	0			1
11006	0			1
11008	0.05		1
11009	0			1
11010	0			1
11017	0			1
11021	0.25		1
11023	0			1
11025	0.1			1
11027	0.25		1
11030	0.25		1
11031	0			1	
11031	0			1
11032	0			1
11035	0			1
11035	0			1
11037	0			1
11039	0			1
11041	0.2			1
11046	0.05		1
11047	0.25		1
11049	0.2			1
11050	0.1			1
11051	0.2			1
11052	0.2			1
11054	0			1
11055	0			1
11057	0			1
11062	0.2			1
11063	0			1
11066	0			1
11068	0.15		1
11069	0			1
11070	0.15		1
11070	0.15		1
11072	0			1
11073	0			1
11075	0.15		1
11075	0.15		1
11077	0.2			1		
11077	0.05		1
11077	0			1
*/